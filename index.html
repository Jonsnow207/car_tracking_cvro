
<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Route Selection &amp; Car Request Form - Logistics Portal</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1e94f6",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101a22",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #334155;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .leaflet-control-container {
            z-index: 15 !important;
        }
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-suggestions {
            position: fixed;
            top: auto;
            left: auto;
            right: 0;
            width: 320px;
            background: white;
            border: 1px solid #dbe1e6;
            border-radius: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            transform: translateX(-360px);
        }
        .dark .autocomplete-suggestions {
            background: #1a2630;
            border-color: #334155;
        }
        .autocomplete-suggestions.show {
            display: block;
        }
        .autocomplete-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dark .autocomplete-item {
            border-bottom-color: #334155;
        }
        .autocomplete-item:hover {
            background-color: #f5f7f8;
        }
        .dark .autocomplete-item:hover {
            background-color: #334155;
        }
        .autocomplete-item-name {
            font-weight: 600;
            color: #111518;
            font-size: 0.875rem;
        }
        .dark .autocomplete-item-name {
            color: white;
        }
        .autocomplete-item-address {
            font-size: 0.75rem;
            color: #60778a;
            margin-top: 4px;
        }
        .dark .autocomplete-item-address {
            color: #9ca3af;
        }
        .route-line {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        .factory-marker {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border: 2px solid #1e94f6;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        .factory-marker .material-symbols-outlined {
            font-size: 18px;
            color: #1e94f6;
        }
        .dark .factory-marker {
            background: #1a2630;
            border-color: #60a5fa;
        }
        #mapInfo {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        /* Zoom animation */
        @keyframes zoomPulse {
          0% {
            transform: scale(1);
          }
          50% {
            transform: scale(1.05);
          }
          100% {
            transform: scale(1);
          }
        }
        .zoom-animation {
          animation: zoomPulse 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111518] dark:text-white font-display overflow-hidden flex flex-col h-screen">
  <!-- Header -->
  <header class="flex-none flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f0f2f5] dark:border-gray-800 bg-white dark:bg-[#101a22] px-6 py-4 z-20 shadow-sm">
    <!-- Logo and Title -->
    <div class="flex items-center gap-4 text-[#111518] dark:text-white">
      <div class="size-8 flex items-center justify-center rounded bg-primary/10 text-primary">
        <span class="material-symbols-outlined">local_shipping</span>
      </div>
      <h2 class="text-[#111518] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Logistics Portal</h2>
    </div>
    <!-- User Profile -->
    <div class="flex items-center gap-4">
      <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-gray-200 dark:border-gray-700" data-alt="User profile picture placeholder" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCTg5LWo2ghP_nkr0yoHz-SH3iE9rxtaLcKrJm3TGWfAjOF1YPHhObZr54omrrm3Hb10wat52oiHxOWJdSNhQeJ8Uk8oDuiTVBqL-iQThrYRvaqpj4JihGwPWGnvTuBHwBR16zY_7zf0vcRiUKECJgiE7RPyIkqlxzWEUP2Y2UITrAbgOSWpzX8Ed2mMqMuXefvC9ZkMYR0_c9YN1h54abtH8AGOMp8Y8K5i5m22BHTy-Y6n7ty2T4zs6xCOkULjoqZbaUZe0iDwXfH");'></div>
    </div>
  </header>
  <!-- Main Content -->
  <div class="flex flex-1 overflow-hidden relative">
    <!-- Sidebar -->
    <aside class="w-full lg:w-[480px] xl:w-[520px] bg-white dark:bg-[#101a22] flex flex-col border-r border-[#dbe1e6] dark:border-gray-800 z-10 shadow-xl lg:shadow-none overflow-y-auto custom-scrollbar overflow-x-visible">
      <!-- Route Calculation Section -->
      <div class="p-6 pb-2">
      <div class="flex flex-col gap-2 mb-6">
        <h1 class="text-[#111518] dark:text-white tracking-tight text-[28px] font-bold leading-tight">Route Calculation</h1>
        <p class="text-[#60778a] dark:text-gray-400 text-sm font-normal leading-normal">Select factory locations to calculate distance for approval.</p>
      </div>
      <div class="relative flex flex-col gap-4">
        <div class="absolute left-[26px] top-[48px] bottom-[48px] w-0.5 border-l-2 border-dashed border-gray-300 dark:border-gray-600 z-0"></div>
        <!-- Point A Input -->
        <div class="relative z-10 group">
          <label class="block">
            <div class="flex items-center justify-between mb-1.5">
              <span class="text-[#111518] dark:text-gray-200 text-sm font-semibold">Origin (Point A)</span>
            </div>
            <div class="autocomplete-container">
              <div class="relative flex items-center">
                <div class="absolute left-3 text-primary">
                  <span class="material-symbols-outlined text-[20px] filled">radio_button_unchecked</span>
                </div>
                <input id="pointAInput" class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-xl text-[#111518] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border border-[#dbe1e6] dark:border-gray-700 bg-white dark:bg-[#1a2630] focus:border-primary h-12 placeholder:text-[#60778a] pl-11 pr-4 text-sm font-normal leading-normal shadow-sm transition-all" placeholder="Search factory or address" value="Factory North - Warehouse A"/>
              </div>
              <div id="pointASuggestions" class="autocomplete-suggestions"></div>
            </div>
          </label>
        </div>
        <!-- Point B Input -->
        <div class="relative z-10 group">
          <label class="block">
            <div class="flex items-center justify-between mb-1.5">
              <span class="text-[#111518] dark:text-gray-200 text-sm font-semibold">Destination (Point B)</span>
            </div>
            <div class="autocomplete-container">
              <div class="relative flex items-center">
                <div class="absolute left-3 text-red-500">
                  <span class="material-symbols-outlined text-[20px]">location_on</span>
                </div>
                <input id="pointBInput" class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-xl text-[#111518] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border border-[#dbe1e6] dark:border-gray-700 bg-white dark:bg-[#1a2630] focus:border-primary h-12 placeholder:text-[#60778a] pl-11 pr-4 text-sm font-normal leading-normal shadow-sm transition-all" placeholder="Search factory or address" value=""/>
              </div>
              <div id="pointBSuggestions" class="autocomplete-suggestions"></div>
            </div>
          </label>
        </div>
      </div>
    </div>
    <!-- Vehicle Preference Section -->
    <div class="px-6 py-4 border-t border-[#f0f2f5] dark:border-gray-800">
      <h3 class="text-[#111518] dark:text-white text-base font-bold leading-tight pb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-gray-400">directions_car</span>
        <span>Vehicle Preference</span>
      </h3>
      <div class="relative group">
        <label class="block">
          <span class="text-[#111518] dark:text-gray-200 text-sm font-semibold mb-1.5 block">Car Type</span>
          <div class="relative flex items-center">
            <div class="absolute left-3 text-[#60778a]">
              <span class="material-symbols-outlined text-[20px]">local_taxi</span>
            </div>
            <select class="form-select flex w-full min-w-0 resize-none overflow-hidden rounded-xl text-[#111518] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border border-[#dbe1e6] dark:border-gray-700 bg-white dark:bg-[#1a2630] focus:border-primary h-12 text-sm font-normal leading-normal shadow-sm transition-all pl-11 cursor-pointer">
              <option>Sedan</option>
              <option>SUV</option>
              <option>Truck</option>
              <option>Van</option>
            </select>
          </div>
        </label>
      </div>
    </div>
    <!-- Contact Information Section -->
    <div class="px-6 py-4 border-t border-[#f0f2f5] dark:border-gray-800">
      <h3 class="text-[#111518] dark:text-white text-base font-bold leading-tight pb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-gray-400">person</span>
        <span>Contact Information</span>
      </h3>
      <div class="flex flex-col gap-4">
        <!-- Full Name Field -->
        <label class="block">
          <span class="text-[#111518] dark:text-gray-200 text-sm font-semibold mb-1.5 block">Full Name</span>
          <div class="relative flex items-center">
            <div class="absolute left-3 text-[#60778a]">
              <span class="material-symbols-outlined text-[20px]">badge</span>
            </div>
            <input class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-xl text-[#111518] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border border-[#dbe1e6] dark:border-gray-700 bg-white dark:bg-[#1a2630] focus:border-primary h-12 placeholder:text-[#60778a] pl-11 pr-4 text-sm font-normal leading-normal shadow-sm transition-all" placeholder="Enter your full name" type="text"/>
          </div>
        </label>
        <!-- Email and Phone Fields -->
        <div class="grid grid-cols-1 gap-4">
          <label class="block">
            <span class="text-[#111518] dark:text-gray-200 text-sm font-semibold mb-1.5 block">Email Address</span>
            <div class="relative flex items-center">
              <div class="absolute left-3 text-[#60778a]">
                <span class="material-symbols-outlined text-[20px]">mail</span>
              </div>
              <input class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-xl text-[#111518] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border border-[#dbe1e6] dark:border-gray-700 bg-white dark:bg-[#1a2630] focus:border-primary h-12 placeholder:text-[#60778a] pl-11 pr-4 text-sm font-normal leading-normal shadow-sm transition-all" placeholder="you@company.com" type="email"/>
            </div>
          </label>
          <label class="block">
            <span class="text-[#111518] dark:text-gray-200 text-sm font-semibold mb-1.5 block">Phone Number</span>
            <div class="relative flex items-center">
              <div class="absolute left-3 text-[#60778a]">
                <span class="material-symbols-outlined text-[20px]">call</span>
              </div>
              <input class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-xl text-[#111518] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border border-[#dbe1e6] dark:border-gray-700 bg-white dark:bg-[#1a2630] focus:border-primary h-12 placeholder:text-[#60778a] pl-11 pr-4 text-sm font-normal leading-normal shadow-sm transition-all" placeholder="(555) 000-0000" type="tel"/>
            </div>
          </label>
        </div>
      </div>
    </div>
    <!-- Distance and Time Display Panel -->
    <div class="flex-1"></div>
    <div class="p-6 mt-auto bg-white dark:bg-[#101a22] sticky bottom-0 border-t border-[#f0f2f5] dark:border-gray-800 z-20">
      <div class="bg-background-light dark:bg-[#1a2630] rounded-xl p-4 border border-[#dbe1e6] dark:border-gray-700 mb-4">
        <div class="flex justify-between items-start mb-4">
          <!-- Total Distance -->
          <div>
            <p class="text-xs font-medium text-[#60778a] uppercase tracking-wider mb-1">Total Distance</p>
            <div class="flex items-baseline gap-2">
              <span id="totalDistanceValue" class="text-2xl font-bold text-[#111518] dark:text-white tracking-tight">14.2</span>
              <span class="text-sm font-medium text-[#60778a]">km</span>
            </div>
          </div>
          <!-- Estimated Time -->
          <div>
            <p class="text-xs font-medium text-[#60778a] uppercase tracking-wider mb-1 text-right">Est. Time</p>
            <div class="flex items-baseline gap-2 justify-end">
              <span id="totalTimeValue" class="text-2xl font-bold text-[#111518] dark:text-white tracking-tight">22</span>
              <span class="text-sm font-medium text-[#60778a]">mins</span>
            </div>
          </div>
        </div>
        <!-- Route Status -->
        <div class="flex items-center gap-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-2 rounded-lg text-sm font-medium">
          <span class="material-symbols-outlined text-[18px]">check_circle</span>
          <span>Route Approved Automatically</span>
        </div>
      </div>
      <!-- Confirm Button -->
      <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 bg-primary hover:bg-blue-600 text-white gap-2 text-base font-bold leading-normal tracking-[0.015em] transition-all shadow-lg shadow-blue-500/30">
        <span>Confirm &amp; Request Car</span>
        <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
      </button>
    </div>
    </aside>
    <!-- Map -->
    <main class="flex-1 relative bg-[#e5e7eb] dark:bg-[#0d131a] overflow-hidden hidden lg:block group">
      <div id="map"></div>
      <!-- Zoom Controls -->
      <div class="absolute bottom-8 right-8 flex flex-col gap-2 shadow-lg rounded-lg overflow-hidden bg-white dark:bg-[#1a2630] border border-gray-200 dark:border-gray-700 z-10">
        <button id="zoomInBtn" class="size-10 flex items-center justify-center text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700 transition-colors">
          <span class="material-symbols-outlined">add</span>
        </button>
        <button id="zoomOutBtn" class="size-10 flex items-center justify-center text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <span class="material-symbols-outlined">remove</span>
        </button>
      </div>
      <!-- Map Info Panel -->
      <div id="mapInfo" class="absolute top-6 right-6 bg-white dark:bg-[#1a2630] rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-3 z-10 max-w-xs">
        <p class="text-xs font-semibold text-[#111518] dark:text-white mb-2">Route Information</p>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <span class="text-xs text-[#60778a] dark:text-gray-400">Status:</span>
            <span id="routeStatus" class="text-xs font-semibold text-[#60778a] dark:text-gray-400">Click to select points</span>
          </div>
          <!-- Route Details (Hidden until route calculated) -->
          <div id="routeDetails" class="hidden border-t border-gray-200 dark:border-gray-700 pt-2">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-[#60778a] dark:text-gray-400">Distance:</span>
              <span id="routeDistance" class="text-xs font-semibold text-[#111518] dark:text-white">-</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs text-[#60778a] dark:text-gray-400">Duration:</span>
              <span id="routeDuration" class="text-xs font-semibold text-[#111518] dark:text-white">-</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    // Initialize map centered on Binh Duong, HCM
    const binhDuongCoords = [10.7769, 106.7669]; // Binh Duong, HCM coordinates
    
    // Vietnam boundaries for optimization
    const vietnamBounds = [
      [8.0, 102.0],    // Southwest corner
      [23.5, 109.5]    // Northeast corner
    ];
    
    let map = L.map('map', {
      maxBounds: vietnamBounds,
      maxBoundsViscosity: 1.0 // Prevent panning outside bounds
    }).setView(binhDuongCoords, 13);
    
    // Restrict zoom levels
    map.setMinZoom(5);  // Minimum zoom to see Vietnam
    map.setMaxZoom(19); // Maximum zoom for detail
    
    // Add OpenStreetMap tiles with Vietnam focus
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19,
      bounds: vietnamBounds
    }).addTo(map);
    
    // State management
    let selectionMode = 'pointA'; // pointA or pointB
    let pointAMarker = null;
    let pointBMarker = null;
    let routeLine = null;
    const factoryMarkerLayer = L.layerGroup().addTo(map);
    
    // Input field references
    const pointAInput = document.getElementById('pointAInput');
    const pointBInput = document.getElementById('pointBInput');
    const pointASuggestions = document.getElementById('pointASuggestions');
    const pointBSuggestions = document.getElementById('pointBSuggestions');
    
    // Initialize with default values
    pointAInput.value = 'BW Supply Chain City (BW SCC) - Office';
    pointBInput.value = 'Landmark 81';
    
    // Add default markers
    function addMarker(lat, lng, isPointB = false) {
      const pinColor = isPointB ? '#ef4444' : '#1e94f6'; // Red for B, Blue for A
      const label = isPointB ? 'B' : 'A';
      
      // Create SVG pin icon
      const svgIcon = `
        <svg width="40" height="50" viewBox="0 0 40 50" xmlns="http://www.w3.org/2000/svg">
          <!-- Pin shadow -->
          <circle cx="20" cy="45" r="8" fill="rgba(0,0,0,0.15)"/>
          
          <!-- Pin body -->
          <path d="M 20 5 C 29 5 36 12 36 21 C 36 35 20 48 20 48 C 20 48 4 35 4 21 C 4 12 11 5 20 5 Z" 
                fill="${pinColor}" opacity="0.9" stroke="white" stroke-width="2"/>
          
          <!-- Pin inner highlight -->
          <ellipse cx="20" cy="19" rx="8" ry="9" fill="white" opacity="0.2"/>
          
          <!-- Label -->
          <text x="20" y="26" font-size="18" font-weight="bold" text-anchor="middle" 
                fill="white" font-family="Arial, sans-serif">${label}</text>
        </svg>
      `;
      
      const icon = L.divIcon({
        className: 'custom-marker',
        html: svgIcon,
        iconSize: [40, 50],
        iconAnchor: [20, 50],
        popupAnchor: [0, -50]
      });
      
      return L.marker([lat, lng], { icon: icon }).addTo(map);
    }

    const factoryIcon = L.divIcon({
      className: 'factory-marker',
      html: '<span class="material-symbols-outlined">factory</span>',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });

    function setPointA(lat, lng, label) {
      if (pointAMarker) {
        map.removeLayer(pointAMarker);
      }
      pointAMarker = addMarker(lat, lng, false);
      pointAInput.value = label;

      const routeStatus = document.getElementById('routeStatus');
      routeStatus.textContent = 'Point A selected. Select Point B';
      routeStatus.classList.remove('text-green-600', 'dark:text-green-400', 'text-amber-600', 'dark:text-amber-400');
      routeStatus.classList.add('text-[#60778a]');
      document.getElementById('routeDetails').classList.add('hidden');

      selectionMode = 'pointB';
      map.setView([lat, lng], 15, { animate: true, duration: 0.5 });
    }

    function setPointB(lat, lng, label) {
      if (pointBMarker) {
        map.removeLayer(pointBMarker);
      }
      pointBMarker = addMarker(lat, lng, true);
      pointBInput.value = label;

      const routeStatus = document.getElementById('routeStatus');
      routeStatus.textContent = 'Calculating distance & time...';
      routeStatus.classList.remove('text-green-600', 'dark:text-green-400', 'text-amber-600', 'dark:text-amber-400');
      routeStatus.classList.add('text-[#60778a]');

      selectionMode = 'pointA';
      drawRoute();
      setTimeout(() => {
        zoomToPoints();
      }, 800);
      map.setView([lat, lng], 15, { animate: true, duration: 0.5 });
    }

    function selectFactoryLocation(location) {
      const lat = parseFloat(location.lat);
      const lng = parseFloat(location.lng);
      const label = location.name || `Location (${lat.toFixed(4)}, ${lng.toFixed(4)})`;

      if (selectionMode === 'pointA') {
        setPointA(lat, lng, label);
      } else {
        setPointB(lat, lng, label);
      }
    }
    
    // Get initial coordinates for default locations
    const pointACoords = [11.0662017, 106.6700739]; // BW Supply Chain City (BW SCC) - Office
    const pointBCoords = [10.7951172, 106.7195211]; // Landmark 81
    
    pointAMarker = addMarker(pointACoords[0], pointACoords[1], false);
    pointBMarker = addMarker(pointBCoords[0], pointBCoords[1], true);
    
    // Snap location to nearest road point
    async function snapToNearestRoad(lat, lng) {
      try {
        const url = `https://router.project-osrm.org/nearest/v1/bike/${lng},${lat}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.waypoints && data.waypoints.length > 0) {
          const snapped = data.waypoints[0];
          return {
            lat: snapped.location[1],
            lng: snapped.location[0],
            distance: snapped.distance,
            name: snapped.name || 'Bike route point'
          };
        }
        return null;
      } catch (error) {
        console.error('Snapping error:', error);
        return null;
      }
    }
    
    // Draw route line
    function drawRoute() {
      if (pointAMarker && pointBMarker) {
        if (routeLine) {
          map.removeLayer(routeLine);
        }
        
        const pointA = pointAMarker.getLatLng();
        const pointB = pointBMarker.getLatLng();
        
        // Fetch shortest route from OSRM
        fetchShortestRoute(pointA.lat, pointA.lng, pointB.lat, pointB.lng);
      }
    }
    
    // Fetch shortest bike route from OSRM API
    async function fetchShortestRoute(lat1, lon1, lat2, lon2) {
      try {
        // Snap both points to nearest bike route if needed
        const pointASnapped = await snapToNearestRoad(lat1, lon1);
        const pointBSnapped = await snapToNearestRoad(lat2, lon2);
        
        let routeLat1 = lat1, routeLon1 = lon1;
        let routeLat2 = lat2, routeLon2 = lon2;
        let snappedMessage = '';
        
        // Check if Point A was snapped
        if (pointASnapped) {
          const distA = pointASnapped.distance;
          if (distA > 10) { // More than 10 meters from route
            routeLat1 = pointASnapped.lat;
            routeLon1 = pointASnapped.lng;
            snappedMessage += `ðŸš´ Point A snapped to bike route (${distA.toFixed(0)}m)\n`;
            console.log('Point A snapped:', pointASnapped);
          }
        }
        
        // Check if Point B was snapped
        if (pointBSnapped) {
          const distB = pointBSnapped.distance;
          if (distB > 10) { // More than 10 meters from route
            routeLat2 = pointBSnapped.lat;
            routeLon2 = pointBSnapped.lng;
            snappedMessage += `ðŸš´ Point B snapped to bike route (${distB.toFixed(0)}m)`;
            console.log('Point B snapped:', pointBSnapped);
          }
        }
        
        // Show snapping notification if occurred
        if (snappedMessage) {
          const routeStatus = document.getElementById('routeStatus');
          routeStatus.textContent = snappedMessage.trim();
          routeStatus.classList.remove('text-green-600', 'dark:text-green-400', 'text-[#60778a]');
          routeStatus.classList.add('text-amber-600', 'dark:text-amber-400');
        }
        
        // Fetch the bike route
        const url = `https://router.project-osrm.org/route/v1/bike/${routeLon1},${routeLat1};${routeLon2},${routeLat2}?overview=full&geometries=geojson`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const coordinates = route.geometry.coordinates;
          
          // Convert coordinates to LatLng format
          const latlngs = coordinates.map(coord => [coord[1], coord[0]]);
          
          // Draw the bike route
          routeLine = L.polyline(latlngs, {
            color: '#ef4444',
            weight: 4,
            opacity: 0.8,
            className: 'route-line'
          }).addTo(map);
          
          // Get distance and duration from OSRM response
          const distance = (route.distance / 1000).toFixed(1); // Convert to km
          const duration = Math.ceil(route.duration / 60); // Convert to minutes
          
          // Update total distance and time display - using specific IDs
          const totalDistanceValue = document.getElementById('totalDistanceValue');
          const totalTimeValue = document.getElementById('totalTimeValue');
          
          if (totalDistanceValue) {
            totalDistanceValue.textContent = distance;
          }
          if (totalTimeValue) {
            totalTimeValue.textContent = duration;
          }
          
          // Update map info panel
          const routeStatus = document.getElementById('routeStatus');
          const routeDetails = document.getElementById('routeDetails');
          const routeDistance = document.getElementById('routeDistance');
          const routeDuration = document.getElementById('routeDuration');
          
          // Only update status if not already showing snapping message
          if (!snappedMessage) {
            routeStatus.textContent = 'âœ“ Bike route calculated';
            routeStatus.classList.remove('text-[#60778a]');
            routeStatus.classList.add('text-green-600', 'dark:text-green-400');
          }
          
          routeDetails.classList.remove('hidden');
          routeDistance.textContent = `${distance} km`;
          routeDuration.textContent = `${duration} mins`;
          
          // Fit map to route with animation
          if (routeLine) {
            const mapElement = document.getElementById('map');
            mapElement.classList.add('zoom-animation');
            
            map.fitBounds(routeLine.getBounds(), { 
              padding: [80, 80],
              maxZoom: 16,
              animate: true,
              duration: 0.8
            });
            
            setTimeout(() => {
              mapElement.classList.remove('zoom-animation');
            }, 800);
          }
        } else {
          // No route found
          const routeStatus = document.getElementById('routeStatus');
          routeStatus.textContent = 'âš  No bike route available for this path';
          routeStatus.classList.remove('text-green-600', 'dark:text-green-400', 'text-[#60778a]');
          routeStatus.classList.add('text-red-600', 'dark:text-red-400');
        }
      } catch (error) {
        console.error('Route calculation error:', error);
        // Show error message
        const routeStatus = document.getElementById('routeStatus');
        routeStatus.textContent = 'âš  Error calculating bike route';
        routeStatus.classList.remove('text-green-600', 'dark:text-green-400', 'text-[#60778a]');
        routeStatus.classList.add('text-red-600', 'dark:text-red-400');
      }
    }
    
    drawRoute();
    
    // List of suggested locations - high frequency visited
    const suggestedLocations = [
      { name : "Au Viet Furniture Co., Ltd", lat:10.182521, lng:106.331657},
        { name : "CÃ´ng ty TNHH Rayten Viá»‡t Nam", lat:10.868847, lng:106.9311306},
        { name : "CÃ´ng ty Glory Oceanic xÆ°á»Ÿng Sofa", lat:11.0910682, lng:106.7594223},
        { name : "Shijie", lat:10.9958889, lng:106.7268889},
        { name : "", lat:11.135836, lng:106.5254686},
        { name : "Cty ViewFull", lat:11.1962525, lng:106.712551},
        { name : "dung dang", lat:11.051341, lng:106.781815},
        { name : "Xin Wang", lat:11.1353827, lng:106.5215759},
        { name : "LM 2", lat:10.8443272, lng:106.9276679},
        { name : "", lat:11.1171111, lng:106.7445556},
        { name : "LiÃªn Nghá»‹", lat:11.3386111, lng:106.7732222},
        { name : "King Jade Co.,Ltd", lat:11.0298846, lng:106.660046},
        { name : "Hoang di", lat:11.1393139, lng:106.5749074},
        { name : "AN THINH", lat:11.1351529, lng:106.7200586},
        { name : "Hong De", lat:11.1316389, lng:106.5231944},
        { name : "PHU DU", lat:11.05266, lng:106.7553482},
        { name : "BW Supply Chain City (BW SCC) - Office", lat:11.0662017, lng:106.6700739},
        { name : "", lat:10.9846111, lng:106.9021111},
        { name : "CÃ´ng ty yuan chen", lat:11.056493, lng:106.732628},
        { name : "Má»™c HoÃ ng LÃ¢m (last update)", lat:10.9846125, lng:106.9021149},
        { name : "", lat:11.3386011, lng:106.7732315},
        { name : "PhÃº Dá»±", lat:11.0525309, lng:106.7554314},
        { name : "Ngá»c Nga", lat:11.0619221, lng:106.8608551},
        { name : "Yuu Yuu Furniture Co. Ltd", lat:11.1388126, lng:106.5504723},
        { name : "Cat Nhon Industrial Complex", lat:13.962952, lng:109.1570888},
        { name : "CÃ´ng Ty Tnhh Má»™t ThÃ nh ViÃªn Phong Thuáº­n HÃ²a", lat:10.991422, lng:106.7515594},
        { name : "JYN YANG CO., LTD", lat:11.3879904, lng:106.5982165},
        { name : "KIM HONG THANH CO.,LTD", lat:10.9991893, lng:106.7286153},
        { name : "ZHI SHENG VIETNAM CO., LTD", lat:11.1356229, lng:106.5251172},
        { name : "YUHONG VIETNAM FURNITURE", lat:11.1819994, lng:106.5194655},
        { name : "YUAN LIN FURNITURE", lat:11.1352103, lng:106.5228001},
        { name : "YU XING VIET NAM", lat:11.2570827, lng:106.6377307},
        { name : "Yong Sheng Furniture Co. Ltd", lat:11.095702, lng:106.780892},
        { name : "WIN WOOD VIETNAM COMPANY LIMITED", lat:11.0291465, lng:106.7430713},
        { name : "WIN WOOD 2 VN CO LTD", lat:11.029238, lng:106.742769},
        { name : "WELL KNOWN HOMEART ENTERPRISE Co., Ltd", lat:10.9307383, lng:106.7526781},
        { name : "WANGFENG1 CO. LTD", lat:11.0289557, lng:106.7151923},
        { name : "VINAFOR SAIGON JCO", lat:10.7914072, lng:106.687305},
        { name : "VIETNAM SENYUAN COMPANY LTD", lat:11.1654523, lng:106.5336091},
        { name : "VIETNAM KINGSMAN WOOD COMPANY LIMITED", lat:11.10144, lng:106.7795291},
        { name : "Vietnam Hang Phong Furniture", lat:11.033691, lng:106.773598},
        { name : "VIET THANG WOOD CO., LTD", lat:11.1392586, lng:106.5391099},
        { name : "VIET NAM HANG LAM FURNITURE COMPANY LIMITED", lat:11.1387274, lng:106.623271},
        { name : "VIEN LAM CO LTD", lat:11.0391233, lng:106.7577911},
        { name : "United Jumbo", lat:10.9581061, lng:107.2364068},
        { name : "TUONG AN WOOD PRODUCTION", lat:11.0908573, lng:106.5470395},
        { name : "TRENDEX CO. LTD", lat:11.0256304, lng:106.6967171},
        { name : "Tran Vuong 3/ Phu Du", lat:11.0525278, lng:106.7554444},
        { name : "Tinh Nhat Pham", lat:11.04128, lng:106.75425},
        { name : "TIEN TRIEN VIETNAM CO. LTD", lat:11.069502, lng:106.7610772},
        { name : "THUONG MY FURNITURE CO., LTD", lat:11.0256757, lng:106.7267127},
        { name : "THE COUNTRY CO. LTD", lat:10.7229146, lng:106.9224858},
        { name : "THANH THANH", lat:11.102827, lng:106.775444},
        { name : "THANG LOI ENTERPRISE", lat:13.782303, lng:109.112134},
        { name : "TAM ICH MOT ONE MEMBER COMPANY LIMITED", lat:11.082876, lng:106.736389},
        { name : "SUNRISE MANUFACTURE CONSTRUCTION & TRADING", lat:11.1421777, lng:106.5496337},
        { name : "Shun Hong Co. LTD", lat:11.0604292, lng:106.7363368},
        { name : "SHING MARK VIETNAM ENTERPRISES CO LTD", lat:10.946526, lng:107.0258933},
        { name : "SEN CHENG WOOD CO.LTD", lat:11.0978727, lng:106.7829724},
        { name : "SAM WELL FURNITURE CO LTD", lat:11.1983008, lng:106.7215115},
        { name : "RK RESOURCES CO LTD", lat:11.2379947, lng:106.6361381},
        { name : "PORA CO LTD", lat:11.096596, lng:106.581326},
        { name : "Phuoc Hung", lat:13.7523294, lng:109.150689},
        { name : "PHU TAI BINH DINH WOOD COMPANY LIMITTED", lat:13.965257, lng:109.1583874},
        { name : "PHAN LE PRODUCTION COMPANY LIMITED", lat:10.9704732, lng:106.7334531},
        { name : "Peng Yuan", lat:11.1364558, lng:106.5271172},
        { name : "OU CHANG WOOD CO., LTD", lat:11.0605678, lng:106.7537854},
        { name : "OMAY VIET NAM WOOD CO.,LTD", lat:11.053401, lng:106.7802572},
        { name : "NS MILLENNIUM VIETNAM COMPANY LIMITED", lat:11.2472475, lng:106.620389},
        { name : "NGU KIM TAM THINH LIMITED LIABILITY COMPANY", lat:10.9274201, lng:106.7580128},
        { name : "Ngu Kim Huang Ding", lat:11.2002068, lng:106.7112931},
        { name : "MU CHENG YE WOOD CO., LTD", lat:11.469221, lng:106.877001},
        { name : "MOTOMOTION VIETNAM LIMITED COMPANY", lat:11.11712, lng:106.650195},
        { name : "MOC HOANG LAM CO., LTD", lat:10.9847324, lng:106.9040535},
        { name : "Ming Ze Furniture Co., Ltd", lat:11.204168, lng:106.7102861},
        { name : "MING YOU FURNITURE CO. LTD", lat:11.037182, lng:106.7585422},
        { name : "MASTER CRAFT VN FURNITURE CO LTD", lat:11.0278992, lng:106.7156909},
        { name : "LONG WEATLH WOOD CO.,", lat:11.229429, lng:106.6881014},
        { name : "LEHOO CÃ”NG TY TNHH SX-TM Lá»¢I HÃ€O VIá»†T NAM (2nd Factory)", lat:11.0850373, lng:106.7748737},
        { name : "LOCTEK ERGONOMICS VN", lat:10.4753739, lng:106.3093686},
        { name : "Lien Nghi", lat:11.3389034, lng:106.7728577},
        { name : "LINHAI FURNITURE CO. LTD", lat:10.996822, lng:106.7211079},
        { name : "Lien Phong", lat:10.938546, lng:106.772423},
        { name : "LEATHER MASTER CO.,LTD", lat:10.8665361, lng:106.9309398},
        { name : "LAP DAT FURNITURE CO. LTD", lat:10.9963328, lng:106.7166689},
        { name : "Kingston Industry Viet Nam Ltd", lat:13.7797355, lng:109.1446228},
        { name : "KIM HONG THANH CO.,LTD", lat:11.0001035, lng:106.7293966},
        { name : "KHOI TRI FURNITURE CO LTD", lat:11.013895, lng:106.7709968},
        { name : "KHANG THINH PHAT CO., LTD", lat:10.7689256, lng:106.6462268},
        { name : "KHANG SHENG WOOD CO.LTD", lat:11.0792936, lng:106.7499957},
        { name : "KAIRUI ENTERPRISES VIET NAM COMPANY LIMITED", lat:10.9856238, lng:106.6888777},
        { name : "JING BO VIET NAM CO., LTD.", lat:11.0958301, lng:106.7826584},
        { name : "JIA HUA VIETNAM LIMITED COMPANY", lat:11.1359522, lng:106.5208069},
        { name : "JIA DING INDUSTRY CO LTD", lat:11.134156, lng:106.51998},
        { name : "HOP THANG INTERIOR WOOD COMPANY LIMITED", lat:11.0919932, lng:106.7794523},
        { name : "HONG VAN COMPANY LIMITED", lat:11.201811, lng:106.709936},
        { name : "HONG MEI VN CO LTD", lat:11.100485, lng:106.7882697},
        { name : "HONG FU VIETNAM CO LTD", lat:11.065062, lng:106.7672678},
        { name : "Hoang Giang", lat:13.790416, lng:109.115333},
        { name : "Hoang Gia", lat:13.9701408, lng:109.1593881},
        { name : "Hoa Thanh Co., Ltd", lat:11.004393, lng:106.7382447},
        { name : "Hoa Huong Duong Furniture Co. Ltd.", lat:11.0382941, lng:106.744301},
        { name : "Hieu Long", lat:11.0092488, lng:106.8902753},
        { name : "HARMOOR VIETNAM CO., LTD", lat:11.382358, lng:106.83242},
        { name : "HAPPY SMART VIETNAM", lat:11.1563777, lng:106.7118225},
        { name : "Happy Furniture VN (Quang Ngai)", lat:15.2193557, lng:108.7974618},
        { name : "HAPPY FURNITURE Co. Ltd", lat:10.8689031, lng:106.9488677},
        { name : "GUAN RUI FURNITURE VN CO., Ltd", lat:11.2106494, lng:106.7076059},
        { name : "GRAND WOOD Co., ltd", lat:11.0924265, lng:106.7626483},
        { name : "GOLDEN LAND FURNITURE VIETNAM", lat:11.0160261, lng:106.7708212},
        { name : "GOLD STAR PRODUCTION", lat:13.7350483, lng:109.1573651},
        { name : "Glory Oceanic ( Vietnam) 1/ 2/3", lat:11.0926446, lng:106.76266},
        { name : "FENG SENG CO., LTD", lat:11.0175452, lng:106.7663726},
        { name : "FENG HENG METAL PRODUCTS CO., LTD", lat:11.1057357, lng:106.8370377},
        { name : "EFS FURNITURE VIETNAM CO LTD", lat:11.0755411, lng:106.7460813},
        { name : "DUC TOAN BINH DINH COMPANY LIMITED", lat:13.831821, lng:109.2694288},
        { name : "DING SHENG VIETNAM CO", lat:11.0940638, lng:106.5554428},
        { name : "DAI THANH FURNITURE JSC", lat:13.7364079, lng:109.1530714},
        { name : "COUNTRY WOOD FURNITURE 2", lat:11.334761, lng:106.60058},
        { name : "COUNTRY WOOD FURNITURE", lat:11.3371151, lng:106.6017577},
        { name : "COMFORT BEDDING COMPANY LIMITED", lat:11.0566942, lng:106.7487178},
        { name : "CHUNG THAM INTL CO LTD", lat:11.064825, lng:106.7593339},
        { name : "CHUANG YUAN VIETNAM CO LTD", lat:11.1367608, lng:106.5287161},
        { name : "CHENGYE WOOD CO LTD", lat:11.0613328, lng:106.752412},
        { name : "CHANGFENG COMPANY LIMITED", lat:11.0854576, lng:106.5652273},
        { name : "CAMHA JOINT STOCK COMPANY", lat:15.8828595, lng:108.2960435},
        { name : "BO MEI", lat:11.0672461, lng:106.8160802},
        { name : "AAA Furniture co,. Ltd", lat:11.030188, lng:106.934629},
        { name : "AN VIET COMPANY LIMITED", lat:10.925512, lng:106.7788348},
        { name : "Anh Khoa Co., LTD", lat:10.9260277, lng:106.781401},
      { name : "BA NHAT RATTAN BAMBOO", lat:11.0796032, lng:106.7868352}
    ];

    function renderSuggestedLocations() {
      factoryMarkerLayer.clearLayers();
      suggestedLocations.forEach(location => {
        const label = location.name || `Factory (${location.lat.toFixed(4)}, ${location.lng.toFixed(4)})`;
        const marker = L.marker([location.lat, location.lng], {
          icon: factoryIcon,
          title: label
        });
        marker.on('click', () => selectFactoryLocation(location));
        marker.bindTooltip(label, { direction: 'top', offset: [0, -8] });
        marker.addTo(factoryMarkerLayer);
      });
    }

    renderSuggestedLocations();
    
    // Calculate match score for search
    function calculateMatchScore(location, searchQuery) {
        if (!searchQuery || searchQuery.trim() === "") return 0;
        
        const query = searchQuery.toLowerCase().trim();
        const name = (location.name || "").toLowerCase();
        
        // Exact match
        if (name === query) return 100;
        // Starts with
        if (name.startsWith(query)) return 85;
        // Contains
        if (name.includes(query)) return 75;
        
        // Word-based matching
        const queryWords = query.split(/\s+/).filter(w => w.length > 0);
        const nameWords = name.split(/[\s,\-./]+/).filter(w => w.length > 0);
        
        let matches = 0;
        queryWords.forEach(qWord => {
            const hasMatch = nameWords.some(nWord => 
                nWord === qWord || nWord.startsWith(qWord) || nWord.includes(qWord)
            );
            if (hasMatch) matches++;
        });
        
        if (matches === queryWords.length) return 70;
        if (matches > 0) return 50 + (matches / queryWords.length) * 20;
        
        return 0;
    }
    
    // Autocomplete function - Vietnam only
    async function searchLocations(query) {
        if (query.length < 2) return [];
        
        try {
            // Get top 3 from suggested locations
            const listResults = suggestedLocations
                .map(location => ({
                    location: location,
                    score: calculateMatchScore(location, query),
                    source: 'list'
                }))
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3)
                .map(item => ({
                    ...item.location,
                    source: 'list'
                }));
            
            // Get top 5 from online
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&bounded=1&viewbox=102.0,23.5,109.5,8.0&countrycodes=vn`,
                {
                    headers: {
                        'Accept-Language': 'en'
                    }
                }
            );
            const onlineResults = await response.json();
            const mappedOnlineResults = onlineResults.map(result => ({
                ...result,
                source: 'online'
            }));
            
            // Combine results - list first, then online (avoiding duplicates)
            const allResults = [...listResults];
            mappedOnlineResults.forEach(onlineResult => {
                const isDuplicate = listResults.some(listResult => {
                    const latDiff = Math.abs(parseFloat(onlineResult.lat) - listResult.lat);
                    const lngDiff = Math.abs(parseFloat(onlineResult.lon) - listResult.lng);
                    return latDiff < 0.001 && lngDiff < 0.001;
                });
                if (!isDuplicate) {
                    allResults.push(onlineResult);
                }
            });
            
            return allResults;
        } catch (error) {
            console.error('Search error:', error);
            return [];
        }
    }
    
    // Display search suggestions
    function displaySuggestions(results, suggestionsContainer, inputField, isPointB = false) {
      suggestionsContainer.innerHTML = '';
      
      if (results.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'autocomplete-item';
        noResults.textContent = 'No results found';
        noResults.style.cursor = 'default';
        suggestionsContainer.appendChild(noResults);
        suggestionsContainer.classList.add('show');
        return;
      }
      
      results.forEach(result => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        
        // Add source badge
        const badge = document.createElement('span');
        const source = result.source || 'online';
        if (source === 'list') {
          badge.className = 'inline-block text-xs font-bold px-2 py-1 rounded mr-2';
          badge.style.backgroundColor = '#DBEAFE';
          badge.style.color = '#1E40AF';
          badge.textContent = 'IN LIST';
        } else {
          badge.className = 'inline-block text-xs font-bold px-2 py-1 rounded mr-2';
          badge.style.backgroundColor = '#DCFCE7';
          badge.style.color = '#15803D';
          badge.textContent = 'ONLINE';
        }
        
        const nameContainer = document.createElement('div');
        nameContainer.className = 'autocomplete-item-name';
        nameContainer.style.display = 'flex';
        nameContainer.style.alignItems = 'center';
        nameContainer.appendChild(badge);
        
        const nameText = document.createElement('span');
        // Handle both suggested locations (name) and Nominatim results (display_name)
        const displayName = result.name || (result.display_name ? result.display_name.split(',')[0] : 'Unknown');
        nameText.textContent = displayName;
        nameContainer.appendChild(nameText);
        
        const address = document.createElement('div');
        address.className = 'autocomplete-item-address';
        // Show full address for online results, coordinates for list results
        address.textContent = result.display_name || `${result.lat.toFixed(4)}, ${result.lng.toFixed(4)}`;
        
        item.appendChild(nameContainer);
        item.appendChild(address);
        
        item.addEventListener('click', () => {
          // Use appropriate name field
          const selectedName = result.name || result.display_name || displayName;
          inputField.value = selectedName;
          suggestionsContainer.classList.remove('show');
          
          // Update marker
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon || result.lng);
          
          if (isPointB) {
            setPointB(lat, lng, selectedName);
          } else {
            setPointA(lat, lng, selectedName);
          }
        });
        
        suggestionsContainer.appendChild(item);
      });
      
      suggestionsContainer.classList.add('show');
    }
    
    // Search event listeners
    let searchTimeoutA;
    pointAInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeoutA);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        pointASuggestions.classList.remove('show');
        return;
      }
      
      searchTimeoutA = setTimeout(async () => {
        const results = await searchLocations(query);
        displaySuggestions(results, pointASuggestions, pointAInput, false);
      }, 300);
    });
    
    let searchTimeoutB;
    pointBInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeoutB);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        pointBSuggestions.classList.remove('show');
        return;
      }
      
      searchTimeoutB = setTimeout(async () => {
        const results = await searchLocations(query);
        displaySuggestions(results, pointBSuggestions, pointBInput, true);
      }, 300);
    });
    
    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.autocomplete-container')) {
        pointASuggestions.classList.remove('show');
        pointBSuggestions.classList.remove('show');
      }
    });
    
    // Map click handler for point selection
    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      
      if (selectionMode === 'pointA') {
        setPointA(lat, lng, `Location (${lat.toFixed(4)}, ${lng.toFixed(4)})`);
      } else {
        setPointB(lat, lng, `Location (${lat.toFixed(4)}, ${lng.toFixed(4)})`);
      }
    });
    
    // Function to zoom to both points with animation
    function zoomToPoints() {
      if (pointAMarker && pointBMarker) {
        const pointA = pointAMarker.getLatLng();
        const pointB = pointBMarker.getLatLng();
        
        // Create bounds from both points
        const bounds = L.latLngBounds([pointA, pointB]);
        
        // Add animation class
        const mapElement = document.getElementById('map');
        mapElement.classList.add('zoom-animation');
        
        // Fit map to bounds with smooth animation and padding
        map.fitBounds(bounds, {
          padding: [80, 80],
          maxZoom: 16,
          animate: true,
          duration: 0.8
        });
        
        // Remove animation class after it completes
        setTimeout(() => {
          mapElement.classList.remove('zoom-animation');
        }, 600);
      }
    }
    
    // Calculate distance (basic Haversine formula)
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // Earth radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return (R * c).toFixed(1);
    }
    
    // Update distance display when markers change
    function updateDistance() {
      if (pointAMarker && pointBMarker) {
        const pointA = pointAMarker.getLatLng();
        const pointB = pointBMarker.getLatLng();
        const distance = calculateDistance(pointA.lat, pointA.lng, pointB.lat, pointB.lng);
        const distanceSpan = document.querySelector('.text-2xl.font-bold.text-[#111518]');
        if (distanceSpan) {
          distanceSpan.textContent = distance;
        }
      }
    }
  </script>
</body>
</html>
