
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Control Route</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #fafafa;
      color: #222;
    }
    h2 {
      margin: 16px 12px 8px;
      font-size: 26px;
    }
    #map { height: 60vh; width: 100%; position: relative; }
    #info { 
      padding: 10px 20px; 
      display: flex; 
      gap: 20px; 
      align-items: flex-start;
      flex-wrap: wrap;
    }
    #info-left {
      flex: 1;
      min-width: 250px;
    }
    #info-right {
      flex: 1;
      min-width: 300px;
    }
    #confirmBtn { display: none; padding: 10px 18px; margin-top: 10px; border: none; background: #2196F3; color: #fff; border-radius: 4px; font-size: 15px; cursor: pointer; }
    #routeLoading { display: none; color: #666; font-size: 14px; margin-top: 10px; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #f3f3f3; border-top: 2px solid #2196F3; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .suggested-locations { 
      padding: 10px; 
      background: #f5f5f5; 
      border-radius: 5px; 
      height: 100%;
    }
    .suggested-locations h3 { margin-top: 0; }
    #locationList {
      max-height: 400px;
      overflow-y: auto;
    }
    .location-item { 
      padding: 8px 10px; 
      margin: 6px 0; 
      cursor: pointer; 
      background: white; 
      border-radius: 4px;
      transition: background 0.2s;
    }
    .location-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
    }
    .location-item:hover { background: #e3f2fd; }
    .location-item.from-list {
      border-left: 3px solid #2196F3;
    }
    .location-item.from-online {
      border-left: 3px solid #4CAF50;
    }
    .location-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
      font-weight: normal;
    }
    .badge-list {
      background: #2196F3;
      color: white;
    }
    .badge-online {
      background: #4CAF50;
      color: white;
    }
    .location-address {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
      word-break: break-word;
    }
    .loading-indicator {
      color: #666;
      padding: 10px;
      font-style: italic;
    }
    .factory-marker {
      background: transparent;
      border: none;
      cursor: pointer;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-24px, -48px);
      pointer-events: auto;
    }
    .factory-marker-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      color: #f44336;
      text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    .factory-marker-icon {
      font-size: 40px;
      line-height: 1;
    }
    .factory-marker-name {
      margin-top: 2px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 11px;
      max-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .leaflet-popup-content {
      padding: 10px;
    }
    @media (max-width: 900px) {
      #map {
        height: 55vh;
      }
      #info {
        flex-direction: column;
        padding: 12px;
      }
      #info-left,
      #info-right {
        width: 100%;
        min-width: unset;
      }
      .suggested-locations {
        height: auto;
      }
      #locationList {
        max-height: 260px;
      }
    }
    @media (max-width: 600px) {
      h2 {
        text-align: center;
        font-size: 22px;
      }
      #map {
        height: 50vh;
      }
      #confirmBtn,
      #locationSearch {
        width: 100%;
      }
      #info {
        gap: 12px;
      }
      .location-item {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>

<body>
  <h2>Select Your Route</h2>
  <div style="background:#e3f2fd; padding:10px 20px; border-left:4px solid #2196F3; margin:0 0 10px 0;">
    <strong>üìç How to use:</strong> Click any location on the map to drop a pin and auto-generate the location, or use search below.
  </div>
  <div id="map"></div>
  <div id="info">
    <div id="info-left">
      <p>Point A: <span id="pointA">Not selected</span></p>
      <p>Point B: <span id="pointB">Not selected</span></p>
      <p>Calculated Distance: <span id="calcDist">0</span> km</p>
      <button id="confirmBtn">Confirm Route</button>
      <div id="routeLoading"><span class="spinner"></span>Calculating route...</div>
    </div>
    <div id="info-right">
      <div class="suggested-locations">
        <h3>Search Locations</h3>
        <input type="text" id="locationSearch" placeholder="Search for a location name..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <div id="locationList"></div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Leaflet map
    let map;
    let pointA = null, pointB = null;
    let markerA, markerB;
    let routingControl = null;
    let suggestedMarkers = [];

    function initMap() {
      map = L.map('map').setView([10.82, 106.68], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Map click: reverse-geocode then show popup with Set as A / Set as B
      map.on('click', async function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        const loc = await reverseGeocode(lat, lng);
        showLocationPopup(lat, lng, loc.name, loc.address);
      });
    }

    // Helper: reverse geocode using Nominatim (free, no API key needed)
    async function reverseGeocode(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        const resp = await fetch(url, { headers: { 'User-Agent': 'CarRouteApp/1.0' } });
        if (!resp.ok) throw new Error('Reverse geocode failed');
        const data = await resp.json();
        return {
          name: data.display_name || `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`,
          address: data.display_name || '',
          lat, lng
        };
      } catch (err) {
        console.warn('Reverse geocode error', err);
        return {
          name: `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`,
          address: '',
          lat, lng
        };
      }
    }

    // Show popup with Set as A / Set as B buttons
    function showLocationPopup(lat, lng, name, address) {
      const popupHtml = `
        <div style="min-width:200px">
          <b>${name}</b>
          <div style="font-size:12px; color:#555; margin-top:6px; margin-bottom:8px;">${address}</div>
          <div style="display:flex; gap:8px;">
            <button class="popup-set-a" style="flex:1; padding:6px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">Set as Point A</button>
            <button class="popup-set-b" style="flex:1; padding:6px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Set as Point B</button>
          </div>
        </div>`;

      const popup = L.popup({ maxWidth: 320 })
        .setLatLng([lat, lng])
        .setContent(popupHtml)
        .openOn(map);

      map.once('popupopen', function(e) {
        const popupEl = e.popup.getElement();
        if (!popupEl) return;
        const btnA = popupEl.querySelector('.popup-set-a');
        const btnB = popupEl.querySelector('.popup-set-b');
        if (btnA) btnA.onclick = () => { setPointAFromLatLng(name, lat, lng); map.closePopup(); };
        if (btnB) btnB.onclick = () => { setPointBFromLatLng(name, lat, lng); map.closePopup(); };
      });
    }

    // Set Point A from coordinates
    function setPointAFromLatLng(name, lat, lng) {
      if (markerA) map.removeLayer(markerA);
      pointA = [lat, lng];
      const factoryIconA = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cmVjdCB4PSI0IiB5PSIxNiIgd2lkdGg9IjI0IiBoZWlnaHQ9IjEyIiBmaWxsPSJub25lIiBzdHJva2U9IiNkMzJmMmYiIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjYiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNkMzJmMmYiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iMTQiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNkMzJmMmYiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iMjIiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNkMzJmMmYiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iOCIgeT0iNiIgd2lkdGg9IjIiIGhlaWdodD0iMTAiIGZpbGw9IiNkMzJmMmYiLz48cmVjdCB4PSIyMiIgeT0iOCIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0iI2QzMmYyZiIvPjwvc3ZnPg==',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });
      markerA = L.marker(pointA, { icon: factoryIconA })
        .addTo(map)
        .bindPopup(`Point A: ${name}`)
        .openPopup();
      document.getElementById('pointA').innerText = `${name} (${pointA.join(', ')})`;
      if (pointB) updateRoute();
    }

    // Set Point B from coordinates
    function setPointBFromLatLng(name, lat, lng) {
      if (!pointA) {
        alert('Please set Point A first.');
        return;
      }
      if (markerB) map.removeLayer(markerB);
      pointB = [lat, lng];
      const factoryIconB = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cmVjdCB4PSI0IiB5PSIxNiIgd2lkdGg9IjI0IiBoZWlnaHQ9IjEyIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjYiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iMTQiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iMjIiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iOCIgeT0iNiIgd2lkdGg9IjIiIGhlaWdodD0iMTAiIGZpbGw9IiMwMDAiLz48cmVjdCB4PSIyMiIgeT0iOCIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0iIzAwMCIvPjwvc3ZnPg==',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });
      markerB = L.marker(pointB, { icon: factoryIconB })
        .addTo(map)
        .bindPopup(`Point B: ${name}`)
        .openPopup();
      document.getElementById('pointB').innerText = `${name} (${pointB.join(', ')})`;
      updateRoute();
    }

    // Update route using OSRM (Open Source Routing Machine - free)
    function updateRoute() {
      if (!pointA || !pointB) return;

      if (routingControl) {
        map.removeControl(routingControl);
      }

      // Show loading indicator
      document.getElementById('routeLoading').style.display = 'block';
      document.getElementById('confirmBtn').style.display = 'none';

      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(pointA[0], pointA[1]),
          L.latLng(pointB[0], pointB[1])
        ],
        router: L.Routing.osrmv1({ 
          serviceUrl: 'https://router.project-osrm.org/route/v1',
          timeout: 10000  // 10 second timeout
        }),
        lineOptions: {
          styles: [{ color: '#2196F3', weight: 5, opacity: 0.8 }]
        },
        addWaypoints: false,
        routeWhileDragging: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        show: false
      }).on('routesfound', function(e) {
        // Hide loading indicator
        document.getElementById('routeLoading').style.display = 'none';
        document.getElementById('confirmBtn').style.display = 'inline-block';
        
        const summary = e.routes[0].summary;
        const distKm = (summary.totalDistance / 1000).toFixed(2);
        document.getElementById('calcDist').innerText = distKm;
      }).on('routeerror', function(e) {
        // Hide loading on error
        document.getElementById('routeLoading').style.display = 'none';
        console.error('Route error:', e);
      }).addTo(map);
    }

    // List of suggested locations - customize with your locations
    const suggestedLocations = [
        { name : "Au Viet Furniture Co., Ltd", lat:10.182521, lng:106.331657},
        { name : "C√¥ng ty TNHH Rayten Vi·ªát Nam", lat:10.868847, lng:106.9311306},
        { name : "C√¥ng ty Glory Oceanic x∆∞·ªüng Sofa", lat:11.0910682, lng:106.7594223},
        { name : "Shijie", lat:10.9958889, lng:106.7268889},
        { name : "", lat:11.135836, lng:106.5254686},
        { name : "Cty ViewFull", lat:11.1962525, lng:106.712551},
        { name : "dung dang", lat:11.051341, lng:106.781815},
        { name : "Xin Wang", lat:11.1353827, lng:106.5215759},
        { name : "LM 2", lat:10.8443272, lng:106.9276679},
        { name : "", lat:11.1171111, lng:106.7445556},
        { name : "Li√™n Ngh·ªã", lat:11.3386111, lng:106.7732222},
        { name : "King Jade Co.,Ltd", lat:11.0298846, lng:106.660046},
        { name : "Hoang di", lat:11.1393139, lng:106.5749074},
        { name : "AN THINH", lat:11.1351529, lng:106.7200586},
        { name : "Hong De", lat:11.1316389, lng:106.5231944},
        { name : "PHU DU", lat:11.05266, lng:106.7553482},
        { name : "BW Supply Chain City (BW SCC) - Office", lat:11.0662017, lng:106.6700739},
        { name : "", lat:10.9846111, lng:106.9021111},
        { name : "C√¥ng ty yuan chen", lat:11.056493, lng:106.732628},
        { name : "M·ªôc Ho√†ng L√¢m (last update)", lat:10.9846125, lng:106.9021149},
        { name : "", lat:11.3386011, lng:106.7732315},
        { name : "Ph√∫ D·ª±", lat:11.0525309, lng:106.7554314},
        { name : "Ng·ªçc Nga", lat:11.0619221, lng:106.8608551},
        { name : "Yuu Yuu Furniture Co. Ltd", lat:11.1388126, lng:106.5504723},
        { name : "Cat Nhon Industrial Complex", lat:13.962952, lng:109.1570888},
        { name : "C√¥ng Ty Tnhh M·ªôt Th√†nh Vi√™n Phong Thu·∫≠n H√≤a", lat:10.991422, lng:106.7515594},
        { name : "JYN YANG CO., LTD", lat:11.3879904, lng:106.5982165},
        { name : "KIM HONG THANH CO.,LTD", lat:10.9991893, lng:106.7286153},
        { name : "ZHI SHENG VIETNAM CO., LTD", lat:11.1356229, lng:106.5251172},
        { name : "YUHONG VIETNAM FURNITURE", lat:11.1819994, lng:106.5194655},
        { name : "YUAN LIN FURNITURE", lat:11.1352103, lng:106.5228001},
        { name : "YU XING VIET NAM", lat:11.2570827, lng:106.6377307},
        { name : "Yong Sheng Furniture Co. Ltd", lat:11.095702, lng:106.780892},
        { name : "WIN WOOD VIETNAM COMPANY LIMITED", lat:11.0291465, lng:106.7430713},
        { name : "WIN WOOD 2 VN CO LTD", lat:11.029238, lng:106.742769},
        { name : "WELL KNOWN HOMEART ENTERPRISE Co., Ltd", lat:10.9307383, lng:106.7526781},
        { name : "WANGFENG1 CO. LTD", lat:11.0289557, lng:106.7151923},
        { name : "VINAFOR SAIGON JCO", lat:10.7914072, lng:106.687305},
        { name : "VIETNAM SENYUAN COMPANY LTD", lat:11.1654523, lng:106.5336091},
        { name : "VIETNAM KINGSMAN WOOD COMPANY LIMITED", lat:11.10144, lng:106.7795291},
        { name : "Vietnam Hang Phong Furniture", lat:11.033691, lng:106.773598},
        { name : "VIET THANG WOOD CO., LTD", lat:11.1392586, lng:106.5391099},
        { name : "VIET NAM HANG LAM FURNITURE COMPANY LIMITED", lat:11.1387274, lng:106.623271},
        { name : "VIEN LAM CO LTD", lat:11.0391233, lng:106.7577911},
        { name : "United Jumbo", lat:10.9581061, lng:107.2364068},
        { name : "TUONG AN WOOD PRODUCTION", lat:11.0908573, lng:106.5470395},
        { name : "TRENDEX CO. LTD", lat:11.0256304, lng:106.6967171},
        { name : "Tran Vuong 3/ Phu Du", lat:11.0525278, lng:106.7554444},
        { name : "Tinh Nhat Pham", lat:11.04128, lng:106.75425},
        { name : "TIEN TRIEN VIETNAM CO. LTD", lat:11.069502, lng:106.7610772},
        { name : "THUONG MY FURNITURE CO., LTD", lat:11.0256757, lng:106.7267127},
        { name : "THE COUNTRY CO. LTD", lat:10.7229146, lng:106.9224858},
        { name : "THANH THANH", lat:11.102827, lng:106.775444},
        { name : "THANG LOI ENTERPRISE", lat:13.782303, lng:109.112134},
        { name : "TAM ICH MOT ONE MEMBER COMPANY LIMITED", lat:11.082876, lng:106.736389},
        { name : "SUNRISE MANUFACTURE CONSTRUCTION & TRADING", lat:11.1421777, lng:106.5496337},
        { name : "Shun Hong Co. LTD", lat:11.0604292, lng:106.7363368},
        { name : "SHING MARK VIETNAM ENTERPRISES CO LTD", lat:10.946526, lng:107.0258933},
        { name : "SEN CHENG WOOD CO.LTD", lat:11.0978727, lng:106.7829724},
        { name : "SAM WELL FURNITURE CO LTD", lat:11.1983008, lng:106.7215115},
        { name : "RK RESOURCES CO LTD", lat:11.2379947, lng:106.6361381},
        { name : "PORA CO LTD", lat:11.096596, lng:106.581326},
        { name : "Phuoc Hung", lat:13.7523294, lng:109.150689},
        { name : "PHU TAI BINH DINH WOOD COMPANY LIMITTED", lat:13.965257, lng:109.1583874},
        { name : "PHAN LE PRODUCTION COMPANY LIMITED", lat:10.9704732, lng:106.7334531},
        { name : "Peng Yuan", lat:11.1364558, lng:106.5271172},
        { name : "OU CHANG WOOD CO., LTD", lat:11.0605678, lng:106.7537854},
        { name : "OMAY VIET NAM WOOD CO.,LTD", lat:11.053401, lng:106.7802572},
        { name : "NS MILLENNIUM VIETNAM COMPANY LIMITED", lat:11.2472475, lng:106.620389},
        { name : "NGU KIM TAM THINH LIMITED LIABILITY COMPANY", lat:10.9274201, lng:106.7580128},
        { name : "Ngu Kim Huang Ding", lat:11.2002068, lng:106.7112931},
        { name : "MU CHENG YE WOOD CO., LTD", lat:11.469221, lng:106.877001},
        { name : "MOTOMOTION VIETNAM LIMITED COMPANY", lat:11.11712, lng:106.650195},
        { name : "MOC HOANG LAM CO., LTD", lat:10.9847324, lng:106.9040535},
        { name : "Ming Ze Furniture Co., Ltd", lat:11.204168, lng:106.7102861},
        { name : "MING YOU FURNITURE CO. LTD", lat:11.037182, lng:106.7585422},
        { name : "MASTER CRAFT VN FURNITURE CO LTD", lat:11.0278992, lng:106.7156909},
        { name : "LONG WEATLH WOOD CO.,", lat:11.229429, lng:106.6881014},
        { name : "LEHOO C√îNG TY TNHH SX-TM L·ª¢I H√ÄO VI·ªÜT NAM (2nd Factory)", lat:11.0850373, lng:106.7748737},
        { name : "LOCTEK ERGONOMICS VN", lat:10.4753739, lng:106.3093686},
        { name : "Lien Nghi", lat:11.3389034, lng:106.7728577},
        { name : "LINHAI FURNITURE CO. LTD", lat:10.996822, lng:106.7211079},
        { name : "Lien Phong", lat:10.938546, lng:106.772423},
        { name : "LEATHER MASTER CO.,LTD", lat:10.8665361, lng:106.9309398},
        { name : "LAP DAT FURNITURE CO. LTD", lat:10.9963328, lng:106.7166689},
        { name : "Kingston Industry Viet Nam Ltd", lat:13.7797355, lng:109.1446228},
        { name : "KIM HONG THANH CO.,LTD", lat:11.0001035, lng:106.7293966},
        { name : "KHOI TRI FURNITURE CO LTD", lat:11.013895, lng:106.7709968},
        { name : "KHANG THINH PHAT CO., LTD", lat:10.7689256, lng:106.6462268},
        { name : "KHANG SHENG WOOD CO.LTD", lat:11.0792936, lng:106.7499957},
        { name : "KAIRUI ENTERPRISES VIET NAM COMPANY LIMITED", lat:10.9856238, lng:106.6888777},
        { name : "JING BO VIET NAM CO., LTD.", lat:11.0958301, lng:106.7826584},
        { name : "JIA HUA VIETNAM LIMITED COMPANY", lat:11.1359522, lng:106.5208069},
        { name : "JIA DING INDUSTRY CO LTD", lat:11.134156, lng:106.51998},
        { name : "HOP THANG INTERIOR WOOD COMPANY LIMITED", lat:11.0919932, lng:106.7794523},
        { name : "HONG VAN COMPANY LIMITED", lat:11.201811, lng:106.709936},
        { name : "HONG MEI VN CO LTD", lat:11.100485, lng:106.7882697},
        { name : "HONG FU VIETNAM CO LTD", lat:11.065062, lng:106.7672678},
        { name : "Hoang Giang", lat:13.790416, lng:109.115333},
        { name : "Hoang Gia", lat:13.9701408, lng:109.1593881},
        { name : "Hoa Thanh Co., Ltd", lat:11.004393, lng:106.7382447},
        { name : "Hoa Huong Duong Furniture Co. Ltd.", lat:11.0382941, lng:106.744301},
        { name : "Hieu Long", lat:11.0092488, lng:106.8902753},
        { name : "HARMOOR VIETNAM CO., LTD", lat:11.382358, lng:106.83242},
        { name : "HAPPY SMART VIETNAM", lat:11.1563777, lng:106.7118225},
        { name : "Happy Furniture VN (Quang Ngai)", lat:15.2193557, lng:108.7974618},
        { name : "HAPPY FURNITURE Co. Ltd", lat:10.8689031, lng:106.9488677},
        { name : "GUAN RUI FURNITURE VN CO., Ltd", lat:11.2106494, lng:106.7076059},
        { name : "GRAND WOOD Co., ltd", lat:11.0924265, lng:106.7626483},
        { name : "GOLDEN LAND FURNITURE VIETNAM", lat:11.0160261, lng:106.7708212},
        { name : "GOLD STAR PRODUCTION", lat:13.7350483, lng:109.1573651},
        { name : "Glory Oceanic ( Vietnam) 1/ 2/3", lat:11.0926446, lng:106.76266},
        { name : "FENG SENG CO., LTD", lat:11.0175452, lng:106.7663726},
        { name : "FENG HENG METAL PRODUCTS CO., LTD", lat:11.1057357, lng:106.8370377},
        { name : "EFS FURNITURE VIETNAM CO LTD", lat:11.0755411, lng:106.7460813},
        { name : "DUC TOAN BINH DINH COMPANY LIMITED", lat:13.831821, lng:109.2694288},
        { name : "DING SHENG VIETNAM CO", lat:11.0940638, lng:106.5554428},
        { name : "DAI THANH FURNITURE JSC", lat:13.7364079, lng:109.1530714},
        { name : "COUNTRY WOOD FURNITURE 2", lat:11.334761, lng:106.60058},
        { name : "COUNTRY WOOD FURNITURE", lat:11.3371151, lng:106.6017577},
        { name : "COMFORT BEDDING COMPANY LIMITED", lat:11.0566942, lng:106.7487178},
        { name : "CHUNG THAM INTL CO LTD", lat:11.064825, lng:106.7593339},
        { name : "CHUANG YUAN VIETNAM CO LTD", lat:11.1367608, lng:106.5287161},
        { name : "CHENGYE WOOD CO LTD", lat:11.0613328, lng:106.752412},
        { name : "CHANGFENG COMPANY LIMITED", lat:11.0854576, lng:106.5652273},
        { name : "CAMHA JOINT STOCK COMPANY", lat:15.8828595, lng:108.2960435},
        { name : "BO MEI", lat:11.0672461, lng:106.8160802},
        { name : "AAA Furniture co,. Ltd", lat:11.030188, lng:106.934629},
        { name : "AN VIET COMPANY LIMITED", lat:10.925512, lng:106.7788348},
        { name : "Anh Khoa Co., LTD", lat:10.9260277, lng:106.781401},
        { name : "BA NHAT RATTAN BAMBOO", lat:11.0796032, lng:106.7868352}

    ];

    // Function to create custom Leaflet marker icon
    function createFactoryIcon(locationName) {
      return L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cmVjdCB4PSI0IiB5PSIxNiIgd2lkdGg9IjI0IiBoZWlnaHQ9IjEyIiBmaWxsPSJub25lIiBzdHJva2U9IiNGRjk4MDAiIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjYiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNGRjk4MDAiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iMTQiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNGRjk4MDAiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iMjIiIHk9IjE4IiB3aWR0aD0iNCIgaGVpZ2h0PSI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNGRjk4MDAiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHJlY3QgeD0iOCIgeT0iNiIgd2lkdGg9IjIiIGhlaWdodD0iMTAiIGZpbGw9IiNGRjk4MDAiLz48cmVjdCB4PSIyMiIgeT0iOCIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0iI0ZGOTgwMCIvPjwvc3ZnPg==',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });
    }

    // Function to clear all suggested markers from map
    function clearSuggestedMarkers() {
      suggestedMarkers.forEach(marker => {
        map.removeLayer(marker);
      });
      suggestedMarkers = [];
    }

    // Function to calculate match score for search (checks both name and address)
    function calculateMatchScore(location, searchQuery) {
      if (!searchQuery || searchQuery.trim() === "") return 0;
      
      const query = searchQuery.toLowerCase().trim();
      const name = (location.name || "").toLowerCase();
      const address = (location.address || "").toLowerCase();
      
      // Split query into individual words for flexible matching
      const queryWords = query.split(/\s+/).filter(w => w.length > 0);
      
      // NAME MATCHING (highest weight)
      if (name === query) return 100; // Exact match
      if (name.startsWith(query)) return 85; // Starts with
      if (name.includes(query)) return 75; // Contains
      
      // Word-based matching on name (prefix + substring)
      const nameWords = name.split(/[\s,\-./]+/).filter(w => w.length > 0);
      let nameWordMatches = 0;
      queryWords.forEach(qWord => {
        const hasMatch = nameWords.some(nWord => 
          nWord === qWord || nWord.startsWith(qWord) || nWord.includes(qWord)
        );
        if (hasMatch) nameWordMatches++;
      });
      if (nameWordMatches === queryWords.length) {
        // All query words matched in name
        return 70 + (nameWordMatches / queryWords.length) * 15;
      }
      if (nameWordMatches > 0) {
        // Partial word match in name
        return 50 + (nameWordMatches / queryWords.length) * 20;
      }
      
      // ADDRESS MATCHING (secondary weight)
      if (address && address.length > 0) {
        // Full phrase in address
        if (address.includes(query)) return 55;
        
        // Word-based matching on address (split by common delimiters)
        const addressWords = address.split(/[\s,\-./]+/).filter(w => w.length > 0);
        let addressWordMatches = 0;
        let addressMatchCount = 0;
        
        queryWords.forEach(qWord => {
          const matchIdx = addressWords.findIndex(aWord => 
            aWord === qWord || aWord.startsWith(qWord) || aWord.includes(qWord)
          );
          if (matchIdx >= 0) {
            addressWordMatches++;
            // Weight earlier words (street address) more than later words (country)
            const weight = 1 - (matchIdx / addressWords.length) * 0.3;
            addressMatchCount += weight;
          }
        });
        
        if (addressWordMatches === queryWords.length) {
          // All query words found in address
          return 45 + (addressMatchCount / queryWords.length) * 15;
        }
        if (addressWordMatches > 0) {
          // Partial address word match
          return 25 + (addressMatchCount / queryWords.length) * 20;
        }
      }
      
      return 0;
    }

    // Function to search online using Nominatim API
    async function searchOnlineLocations(searchQuery) {
      try {
        // Use Nominatim (OpenStreetMap) geocoding API
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&countrycodes=vn&addressdetails=1`;
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'CarRouteApp/1.0'
          }
        });
        
        if (!response.ok) {
          return [];
        }
        
        const data = await response.json();
        return data.map(result => ({
          name: (result.display_name?.split(',')[0] || result.display_name || 'Location').trim(),
          address: result.display_name || 'Unknown address',
          lat: parseFloat(result.lat),
          lng: parseFloat(result.lon),
          source: 'online'
        }));
      } catch (error) {
        console.error('Online search error:', error);
        return [];
      }
    }

    // Function to add location to map and list
    function addLocationToDisplay(location, isFromList = false) {
      const locationList = document.getElementById("locationList");
      
      // Add marker to map using Leaflet with popup buttons to set A or B
      const popupHtml = `
        <div style="min-width:200px">
          <b>${location.name || "Location"}</b>
          <div style="font-size:12px; color:#555; margin-top:6px;">${location.address || (`Lat: ${location.lat.toFixed(6)}, Lng: ${location.lng.toFixed(6)}`)}</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="popup-set-a" style="flex:1; padding:6px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">Set as Point A</button>
            <button class="popup-set-b" style="flex:1; padding:6px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">Set as Point B</button>
          </div>
        </div>`;

      const marker = L.marker([location.lat, location.lng], { icon: createFactoryIcon(location.name) })
        .addTo(map)
        .bindPopup(popupHtml);

      // attach marker reference to location for list-clicks
      location._marker = marker;
      suggestedMarkers.push(marker);

      // when popup opens on this marker, wire the buttons
      marker.on('popupopen', function(e) {
        const popupEl = e.popup.getElement();
        if (!popupEl) return;
        const btnA = popupEl.querySelector('.popup-set-a');
        const btnB = popupEl.querySelector('.popup-set-b');
        if (btnA) {
          btnA.onclick = () => {
            setPointAFromLatLng(location.name || 'Selected location', location.lat, location.lng);
            marker.closePopup();
          };
        }
        if (btnB) {
          btnB.onclick = () => {
            setPointBFromLatLng(location.name || 'Selected location', location.lat, location.lng);
            marker.closePopup();
          };
        }
      });

      // Add to list
      const item = document.createElement("div");
      item.className = `location-item ${isFromList ? 'from-list' : 'from-online'}`;
      
      const header = document.createElement("div");
      header.className = "location-item-header";
      
      const nameSpan = document.createElement("span");
      nameSpan.textContent = location.name || "Unnamed Location";
      
      const badge = document.createElement("span");
      badge.className = `location-badge ${isFromList ? 'badge-list' : 'badge-online'}`;
      badge.textContent = isFromList ? "List" : "Online";
      
      header.appendChild(nameSpan);
      header.appendChild(badge);
      item.appendChild(header);
      
      const addressText = location.address || `Lat: ${location.lat?.toFixed(6)}, Lng: ${location.lng?.toFixed(6)}`;
      const addressDiv = document.createElement("div");
      addressDiv.className = "location-address";
      addressDiv.textContent = addressText;
      item.appendChild(addressDiv);
      
      item.onclick = () => {
        if (location._marker) {
          map.setView([location.lat, location.lng], 14);
          location._marker.openPopup();
        }
      };
      locationList.appendChild(item);
    }

    // Function to search and display matching locations
    async function searchAndDisplayLocations(searchQuery) {
      clearSuggestedMarkers();
      const locationList = document.getElementById("locationList");
      locationList.innerHTML = "";

      if (!searchQuery || searchQuery.trim() === "") {
        return;
      }

      // Show loading indicator
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "loading-indicator";
      loadingDiv.textContent = "Searching...";
      locationList.appendChild(loadingDiv);

      // Get top 5 from existing list
      const scoredLocations = suggestedLocations
        .map(location => ({
          location: location,
          score: calculateMatchScore(location, searchQuery)
        }))
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 5); // Top 5 results

      // Clear loading and add list results
      locationList.innerHTML = "";

      // Add top 5 from list
      scoredLocations.forEach(({ location }) => {
        addLocationToDisplay(location, true);
      });

      // Search online and add results
      const onlineResults = await searchOnlineLocations(searchQuery);
      onlineResults.forEach(location => {
        // Check if this online result is already in our list (avoid duplicates)
        const isDuplicate = suggestedMarkers.some(marker => {
          const markerLatLng = marker.getLatLng();
          const markerLat = markerLatLng.lat;
          const markerLng = markerLatLng.lng;
          const distance = Math.sqrt(
            Math.pow(markerLat - location.lat, 2) + 
            Math.pow(markerLng - location.lng, 2)
          );
          return distance < 0.001; // Very close coordinates (same location)
        });
        
        if (!isDuplicate) {
          addLocationToDisplay(location, false);
        }
      });

      // Show message if no results
      if (suggestedMarkers.length === 0) {
        locationList.innerHTML = "<p style='color: #666; padding: 10px;'>No matching locations found.</p>";
        return;
      }

      // Fit map to show all markers
      if (suggestedMarkers.length > 0) {
        const bounds = L.latLngBounds([]);
        suggestedMarkers.forEach(marker => {
          bounds.extend(marker.getLatLng());
        });
        map.fitBounds(bounds.pad(0.1));
      }
    }

    // Function to add suggested locations to map (deprecated, kept for compatibility)
    function addSuggestedLocations() {
      // This function is no longer used, but kept for backward compatibility
      // Search functionality is now handled by searchAndDisplayLocations
    }

    // Function to render route between Point A and Point B using Leaflet Routing Machine
    // Using OSRM (Open Source Routing Machine) - free, no API key needed
    // Already implemented in updateRoute() above

    // Setup search input event listener
    const searchInput = document.getElementById("locationSearch");
    let searchTimeout;
    searchInput.addEventListener("input", function(e) {
      clearTimeout(searchTimeout);
      const query = e.target.value;
      searchTimeout = setTimeout(() => {
        searchAndDisplayLocations(query);
      }, 300); // Debounce search by 300ms
    });

    // Confirm button action
    document.getElementById("confirmBtn").addEventListener("click", () => {
      const result = {
        pointA: pointA,
        pointB: pointB,
        calculatingDistance: document.getElementById("calcDist").innerText
      };
      alert("Route confirmed:\n" + JSON.stringify(result, null, 2));
      // üëâ replace alert() with fetch("YOUR_POWER_AUTOMATE_URL", {...}) later
    });

    // Initialize the map when the page loads
    window.addEventListener('load', initMap);
  </script>
</body>
</html>
